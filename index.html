<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Colegio T√©cnico Vicente Azuero ‚Äì Aprobaciones</title>
  <!-- SheetJS para exportar a Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:22px;font-family:Segoe UI,Tahoma,Verdana,sans-serif}
    .container{max-width:1200px;margin:0 auto}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);overflow:hidden}
    .header{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:18px 22px;flex-wrap:wrap}
    .title{font-size:22px;font-weight:800}
    .badge{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:999px;padding:6px 12px}
    .panel{background:#fff;border-radius:16px;margin:12px 0;padding:14px 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button,select,input{padding:10px;border-radius:10px;border:2px solid #e5e7eb;font-size:14px}
    button{background:#6970f6;color:#fff;border:none;cursor:pointer} button:hover{opacity:.92}
    .ghost{background:#e5e7eb;color:#111}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .stat{background:#fff;border-radius:12px;padding:16px;text-align:center;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .stat .n{font-size:30px;font-weight:900;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .table{overflow:auto;border-radius:16px}
    table{width:100%;border-collapse:collapse} th,td{padding:12px 14px;border-bottom:1px solid #f1f5f9}
    th{background:#f8fafc;font-weight:700;cursor:pointer;user-select:none}
    th.nosort{cursor:default}
    .chip{display:inline-block;font-size:12px;padding:5px 10px;border-radius:999px;border:1px solid #e5e7eb;margin-right:6px}
    .ok{background:#d4edda;color:#155724;border-color:#c3e6cb}
    .warn{background:#fff3cd;color:#856404;border-color:#ffe69c}
    .bad{background:#f8d7da;color:#721c24;border-color:#f5c6cb}
    .info{background:#e3f2fd;color:#1976d2;border-color:#bbdefb}
    .muted{background:#eee;color:#444;border-color:#ddd}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn-ok{background:#28a745} .btn-bad{background:#dc3545} .btn-doc{background:#ff9800} .btn-lock{background:#9e9e9e} .btn-rev{background:#6b7280} .btn-info{background:#17a2b8}
    .note{position:fixed;right:20px;top:20px;padding:12px 16px;border-radius:10px;color:#fff;display:none;box-shadow:0 10px 20px rgba(0,0,0,.2);z-index:99}
    .note.success{background:#16a34a} .note.error{background:#dc2626} .note.info{background:#0284c7}
    /* Modal ficha */
    .modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:999}
    .modal-card{background:#fff;border-radius:14px;max-width:920px;margin:40px auto;padding:18px 20px;max-height:85vh;overflow:auto}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .close{cursor:pointer;font-size:22px}
    /* Login modal */
    .login{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:1000}
    .login-card{background:#fff;border-radius:14px;max-width:420px;margin:8% auto;padding:22px}
    .hint{font-size:12px;color:#6b7280}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:600px){.grid{grid-template-columns:1fr} th,td{font-size:12px;padding:9px}}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div class="login" id="login">
    <div class="login-card">
      <h2 style="margin:0 0 6px">üîê Ingreso</h2>
      <p class="hint" style="margin:0 0 12px">Escribe tu contrase√±a de coordinador o de administrador.</p>
      <input id="pass" type="password" placeholder="Contrase√±a‚Ä¶" style="width:100%;margin-bottom:10px">
      <div class="row" style="justify-content:flex-end">
        <button class="ghost" onclick="cancelLogin()">Cancelar</button>
        <button onclick="doLogin()">Ingresar</button>
      </div>
      <div id="loginMsg" class="hint" style="color:#dc2626;margin-top:8px;display:none">Contrase√±a inv√°lida</div>
      <hr style="margin:14px 0; border:none; border-top:1px solid #eee">
      <div class="hint">
        Roles disponibles (ejemplo):<br>
        <b>Administrador</b>, <b>Sede A Ma√±ana</b>, <b>Sede A Tarde</b>, <b>Sede B</b>, <b>Sede C</b>, <b>Sede D</b>.
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="container" id="app" style="display:none">
    <div class="card">
      <div class="header">
        <div class="title">üéì Colegio T√©cnico Vicente Azuero ‚Äì Aprobaciones</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="badge" id="userBadge">Rol</div>
          <button class="ghost" id="logout">Cerrar sesi√≥n</button>
        </div>
      </div>

      <!-- Barra de acciones -->
      <div class="panel">
        <div class="row">
          <button id="sync">üîÑ Sincronizar</button>
          <button id="export">üìä Exportar Excel</button>
          <button id="bulkOk" class="btn-ok">‚úÖ Aprobar seleccionados</button>
          <button id="bulkBad" class="btn-bad">‚ùå Rechazar seleccionados</button>
          <button id="bulkRev" class="btn-rev">‚Ü© Reversar seleccionados</button>
          <small id="lastSync" style="color:#6b7280;margin-left:8px"></small>
        </div>
      </div>

      <!-- Stats -->
      <div class="grid">
        <div class="stat"><div class="n" id="stTotal">0</div><div>TOTAL ESTUDIANTES</div></div>
        <div class="stat"><div class="n" id="stPend">0</div><div>PENDIENTES</div></div>
        <div class="stat"><div class="n" id="stOk">0</div><div>APROBADOS</div></div>
        <div class="stat"><div class="n" id="stBad">0</div><div>RECHAZADOS</div></div>
      </div>

      <!-- Filtros -->
      <div class="panel">
        <div class="row">
          <select id="sedeF"><option value="">Todas las Sedes</option></select>
          <select id="gradoF">
            <option value="">Todos los Grados</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option>
          </select>
          <select id="estadoF">
            <option value="">Todos los Estados</option>
            <option>Pendiente</option><option>En Progreso</option><option>Aprobar</option><option>Rechazar</option><option>Solicitar Documentos</option><option>Bloqueado</option>
          </select>
          <input id="busca" placeholder="Buscar estudiante o documento‚Ä¶">
        </div>
      </div>

      <!-- Tabla -->
      <div class="panel table">
        <table>
          <thead>
          <tr>
            <th class="nosort"><input type="checkbox" id="chkAll"></th>
            <th onclick="sortBy('nombre')">Nombre</th>
            <th onclick="sortBy('documento')">Documento</th>
            <th onclick="sortBy('grado')">Grado</th>
            <th onclick="sortBy('sede')">Sede</th>
            <th onclick="sortBy('jornada')">Jornada</th>
            <th class="nosort">Estado</th>
            <th class="nosort">Acciones</th>
          </tr>
          </thead>
          <tbody id="tbody"><tr><td colspan="8" style="text-align:center">Cargando‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Ficha estudiante -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="mTitle">Detalle del estudiante</h3>
        <span class="close" id="mClose">√ó</span>
      </div>
      <div id="mBody"></div>
    </div>
  </div>

  <div id="note" class="note"></div>

  <script>
    // ========= AJUSTA ESTO A TUS SEDES REALES =========
    // Mapa de alias "Sede A/B/C/D" a los textos exactos que llegan desde Jotform.
    const SEDE_MAP = {
      'Sede A': 'Colegio Tecnico Vicente Azuero - Lagos 2',
      'Sede B': 'Colegio Tecnico Vicente Azuero - Principal',
      'Sede C': 'Instituto Andres Bello - Lagos 1',
      'Sede D': 'Instituto Juan Pablo I - Lagos 2'
    };

    // ========= ROLES+CONTRASE√ëAS ==========
    const ROLES = {
      admin:        { name:'Administrador', pass:'admin123', canAll:true },
      sedeA_manana: { name:'Sede A ‚Äì Ma√±ana', pass:'aM2024', sede:SEDE_MAP['Sede A'], jornada:'Ma√±ana' },
      sedeA_tarde:  { name:'Sede A ‚Äì Tarde',  pass:'aT2024', sede:SEDE_MAP['Sede A'], jornada:'Tarde' },
      sedeB:        { name:'Sede B',          pass:'b2024',  sede:SEDE_MAP['Sede B'] },
      sedeC:        { name:'Sede C',          pass:'c2024',  sede:SEDE_MAP['Sede C'] },
      sedeD:        { name:'Sede D',          pass:'d2024',  sede:SEDE_MAP['Sede D'] },
    };
    let CURRENT_ROLE_KEY = localStorage.getItem('role_key') || null;
    const CURRENT_ROLE = ()=> CURRENT_ROLE_KEY ? ROLES[CURRENT_ROLE_KEY] : null;

    // ========= PROXY TOKEN (mismo que PROXY_SECRET en Vercel) =========
    const PROXY_TOKEN = '12345-seguro';
    const ALLOWED_STATES = ['Pendiente','Aprobar','Rechazar','Solicitar Documentos','Bloqueado','En Progreso'];

    // ========= STATE =========
    let FORM_ID_LINK = null;
    let all = [];
    let view = [];
    let sortKey = null, sortDir = 1;

    const $ = id => document.getElementById(id);
    const note = (msg,type='info')=>{ const n=$('note'); n.textContent=msg; n.className='note '+type; n.style.display='block'; setTimeout(()=>n.style.display='none',2200); };
    const cls = (estado)=>{ const n=(estado||'').toLowerCase();
      if(n.includes('aproba')) return 'ok';
      if(n.includes('rechaz') || n.includes('no aprob')) return 'bad';
      if(n.includes('progreso')) return 'info';
      if(n.includes('solicitar')) return 'warn';
      if(n.includes('bloque')) return 'muted';
      return 'warn';
    };
    function normalize(s){return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();}

    // ======== LOGIN ========
    function showLogin(){ $('login').style.display='block'; $('app').style.display='none'; }
    function hideLogin(){ $('login').style.display='none'; $('app').style.display='block'; }
    function cancelLogin(){ $('pass').value=''; showLogin(); }
    function doLogin(){
      const p = $('pass').value.trim();
      const okKey = Object.keys(ROLES).find(k=>ROLES[k].pass===p);
      if(!okKey){ $('loginMsg').style.display='block'; return; }
      CURRENT_ROLE_KEY = okKey;
      localStorage.setItem('role_key', CURRENT_ROLE_KEY);
      $('userBadge').textContent = ROLES[CURRENT_ROLE_KEY].name;
      $('loginMsg').style.display='none';
      $('pass').value='';
      hideLogin();
      bootAfterLogin();
    }
    $('logout').onclick = ()=>{
      localStorage.removeItem('role_key');
      location.reload();
    };

    // ======== META (formId para link de Submissions) ========
    async function loadFormId(){
      try{
        const r = await fetch('/api/jotform/meta');
        const j = await r.json();
        if(j?.formId) FORM_ID_LINK = j.formId;
      }catch(_){}
    }

    // ======== SYNC ========
    async function sync() {
      try{
        const r = await fetch('/api/jotform/list');
        const data = await r.json();
        if(!data?.content){ $('tbody').innerHTML='<tr><td colspan="8" style="text-align:center">Sin datos</td></tr>'; return; }

        const sedes = new Set();
        all = data.content.map((sub)=>{
          const a = sub.answers||{};
          const nombres   = a['4']?.answer || a['4']?.prettyFormat || '';
          const apellidos = a['5']?.answer || a['5']?.prettyFormat || '';
          const sede      = a['2']?.answer || '‚Äî';
          const jornada   = a['3']?.answer || '‚Äî';
          const grado     = a['8']?.answer || '1';
          const doc       = a['7']?.answer || 'Sin documento';

          // Estado JF: busca por etiqueta "Estado de Aprobaci√≥n"
          let estadoJF = '';
          for(const k in a){
            const lbl = normalize(a[k]?.text||'');
            if(lbl.includes('estado de aprobacion')) { estadoJF = a[k]?.answer || ''; break; }
          }
          sedes.add(sede);
          return {
            submissionId: sub.id,
            nombre: `${nombres} ${apellidos}`.trim() || 'Sin nombre',
            documento: doc, grado, sede, jornada,
            estadoUI: estadoJF || 'Pendiente',
            estadoJF: estadoJF || '',
            raw: {a, created_at: sub.created_at}
          };
        });

        // llenamos filtro de sedes
        const sedeSel = $('sedeF');
        sedeSel.innerHTML = '<option value="">Todas las Sedes</option>' + [...sedes].map(s=>`<option>${s}</option>`).join('');

        $('lastSync').textContent = '√öltima sincronizaci√≥n: ' + new Date().toLocaleString('es-CO');
        render();
        note(`Sincronizado (${all.length})`,'success');
      }catch(e){
        console.error(e); note('No se pudo sincronizar','error');
      }
    }

    function sortBy(k){
      if(sortKey===k) sortDir = -sortDir; else { sortKey = k; sortDir = 1; }
      render();
    }

    function render(){
      const sedeF = $('sedeF').value;
      const gradoF = $('gradoF').value;
      const estF = $('estadoF').value;
      const q = ($('busca').value||'').toLowerCase();

      // filtro por rol
      const role = CURRENT_ROLE() || ROLES.admin;
      let base = [...all];
      if (!role.canAll) {
        base = base.filter(s=>{
          const sedeOk  = !role.sede    || s.sede===role.sede;
          const jorOk   = !role.jornada || s.jornada===role.jornada;
          const gradoOk = !role.grados  || role.grados.includes(s.grado);
          return sedeOk && jorOk && gradoOk;
        });
      }

      // filtros UI
      view = base.filter(s=>{
        return (!sedeF || s.sede===sedeF) &&
               (!gradoF || s.grado===gradoF) &&
               (!estF || s.estadoUI===estF) &&
               (!q || s.nombre.toLowerCase().includes(q) || (s.documento||'').includes(q));
      });

      if(sortKey){
        view.sort((a,b)=>{
          const va = (a[sortKey]||'').toString().toLowerCase();
          const vb = (b[sortKey]||'').toString().toLowerCase();
          if(va<vb) return -1*sortDir;
          if(va>vb) return  1*sortDir;
          return 0;
        });
      }

      $('stTotal').textContent = view.length;
      $('stPend').textContent  = view.filter(x=>x.estadoUI==='Pendiente' || x.estadoUI==='En Progreso').length;
      $('stOk').textContent    = view.filter(x=>x.estadoUI==='Aprobar').length;
      $('stBad').textContent   = view.filter(x=>x.estadoUI==='Rechazar' || x.estadoUI==='No Aprobado').length;

      const tb = $('tbody');
      if(view.length===0){ tb.innerHTML = '<tr><td colspan="8" style="text-align:center">Sin resultados</td></tr>'; return; }

      tb.innerHTML = view.map((s,i)=>{
        const jfUrl = FORM_ID_LINK
          ? `https://www.jotform.com/submissions/${FORM_ID_LINK}?sid=${s.submissionId}&mode=full`
          : '#';
        return `
        <tr>
          <td><input type="checkbox" class="rowchk" data-id="${s.submissionId}"></td>
          <td>${s.nombre}</td>
          <td>${s.documento}</td>
          <td>${s.grado}¬∞</td>
          <td>${s.sede}</td>
          <td>${s.jornada}</td>
          <td>
            <span class="chip ${cls(s.estadoUI)}">UI: ${s.estadoUI||'‚Äî'}</span>
            <span class="chip ${cls(s.estadoJF||'Pendiente')}">JF: ${s.estadoJF||'‚Äî'}</span>
          </td>
          <td class="actions">
            ${(['Pendiente','En Progreso'].includes(s.estadoUI))? `<button class="btn-ok" onclick="act(${i},'Aprobar')">‚úÖ</button>`:''}
            ${(['Pendiente','En Progreso'].includes(s.estadoUI))? `<button class="btn-bad" onclick="act(${i},'Rechazar')">‚ùå</button>`:''}
            ${(['Pendiente','En Progreso'].includes(s.estadoUI))? `<button class="btn-doc" onclick="act(${i},'Solicitar Documentos')">üìÑ</button>`:''}
            ${(['Pendiente','En Progreso'].includes(s.estadoUI))? `<button class="btn-lock" onclick="act(${i},'Bloqueado')">üîí</button>`:''}
            ${(!['Pendiente','En Progreso'].includes(s.estadoUI))? `<button class="btn-rev" onclick="reversar(${i})">‚Ü©</button>`:''}
            <button class="btn-info" onclick="ver(${i})">Ver</button>
            ${FORM_ID_LINK ? `<a class="btn-info" style="text-decoration:none;padding:10px" target="_blank" href="${jfUrl}">üì¨ JF</a>`:''}
          </td>
        </tr>`;
      }).join('');
    }

    async function act(idx, nuevoEstado){
      const row = view[idx];
      const reg = all.find(x=>x.submissionId===row.submissionId);
      if(!reg) return;

      // permiso por rol
      const role = CURRENT_ROLE() || ROLES.admin;
      if (!role.canAll) {
        const sedeOk  = !role.sede    || reg.sede===role.sede;
        const jorOk   = !role.jornada || reg.jornada===role.jornada;
        const gradoOk = !role.grados  || role.grados.includes(reg.grado);
        if(!(sedeOk && jorOk && gradoOk)){ note('No tienes permiso para esta acci√≥n','error'); return; }
      }

      if(ALLOWED_STATES.length && !ALLOWED_STATES.includes(nuevoEstado)){
        note(`"${nuevoEstado}" no coincide con las opciones`, 'error'); return;
      }

      // UI optimista
      reg.estadoUI = nuevoEstado; render();

      try{
        const verificado = await actualizarEstadoEnJotform(reg.submissionId, nuevoEstado);
        reg.estadoJF = verificado || nuevoEstado;
        render();
        await enviarCorreoCambioEstado(reg, nuevoEstado);
        note('Actualizado ‚úî','success');
      }catch(e){
        console.error(e); note('No se pudo escribir en Jotform','error');
      }
    }

    function reversar(idx){
      const motivo = prompt('Motivo para reversar a Pendiente:');
      if(motivo===null) return;
      act(idx,'Pendiente').then(()=>{
        const row = view[idx];
        const log = JSON.parse(localStorage.getItem('audit_log')||'[]');
        log.push({ submissionId: row.submissionId, accion: 'Reversar', motivo, fecha: new Date().toISOString() });
        localStorage.setItem('audit_log', JSON.stringify(log));
        note('Reversado con motivo guardado','success');
      });
    }

    // === Proxy update ===
    async function actualizarEstadoEnJotform(submissionId, nuevoEstado) {
      const payload = { submissionId, formId: 'env', value: nuevoEstado };
      const resp = await fetch('/api/jotform/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Auth-Token': PROXY_TOKEN },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data?.error || 'Error JF');
      return data.verified;
    }

    // === Emails ===
    async function enviarCorreoCambioEstado(registro, nuevoEstado){
      try{
        const a = registro.raw?.a || {};
        const email = a['22']?.answer || a['38']?.answer || '';
        if(!email) return;

        const subject = {
          'Aprobar': '‚úÖ Inscripci√≥n aprobada',
          'Rechazar': '‚ùå Inscripci√≥n no aprobada',
          'Solicitar Documentos': 'üìÑ Faltan documentos para tu inscripci√≥n',
          'Bloqueado': 'üîí Inscripci√≥n bloqueada',
          'Pendiente': '‚Ü© Tu inscripci√≥n fue reversada a Pendiente'
        }[nuevoEstado] || `Actualizaci√≥n de estado: ${nuevoEstado}`;

        const html = `
          <p>Hola ${registro.nombre},</p>
          <p>Tu estado de inscripci√≥n cambi√≥ a: <b>${nuevoEstado}</b>.</p>
          <p>Sede: ${registro.sede} ‚Äî Jornada: ${registro.jornada} ‚Äî Grado: ${registro.grado}¬∞</p>
          <p>Si tienes dudas, responde a este correo.</p>
        `;

        await fetch('/api/notify/send', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-Auth-Token': PROXY_TOKEN },
          body: JSON.stringify({ to: email, subject, html })
        });
      }catch(e){ console.warn('No se pudo enviar correo:', e); }
    }

    // === Adjuntos: convierte answer a array de URLs ===
    function listUrls(ans){
      if(!ans) return [];
      if(Array.isArray(ans)) return ans;
      if(typeof ans === 'string'){
        // separador por coma o salto de l√≠nea
        return ans.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
      }
      return [];
    }

    // === Ficha ===
    function ver(idx){
      const s = view[idx];
      $('mTitle').textContent = s.nombre;
      const a = s.raw?.a || {};
      const get = (k, alt='‚Äî') => a[k]?.answer || a[k]?.prettyFormat || alt;

      const nombres   = get('4','');
      const apellidos = get('5','');
      const tipoDoc   = get('98','');
      const doc       = s.documento || '‚Äî';
      const genero    = get('6','');
      const fnac      = get('10','');
      const edad      = get('11','');
      const rh        = get('10','');

      const grado     = s.grado || '‚Äî';
      const sede      = s.sede  || '‚Äî';
      const jornada   = s.jornada || '‚Äî';
      const idUnico   = get('96','No asignado');

      const email     = get('22', get('17',''));
      const cel       = get('21', get('29',''));
      const dir       = get('12','');
      const barrio    = get('13','');
      const ciudad    = get('15','');
      const estrato   = get('14','');

      const acudiente = get('35','');
      const docAcud   = get('36','');
      const telAcud   = get('37','');
      const emailAcud = get('38','');
      const parentesc = get('42','');

      const madreNom  = get('19','');
      const madreCel  = get('21','');
      const padreNom  = get('27','');
      const padreCel  = get('29','');

      const eps       = get('44','');
      const sisben    = get('45','');
      const etnia     = get('46','');
      const disca     = get('47','Ninguna');
      const despl     = get('48','No');

      const foto      = listUrls(get('73',''));
      const boletin   = listUrls(get('61',''));
      const docIdent  = listUrls(get('62',''));
      const obs       = get('64','');

      const linkList = (arr,label)=> arr.length ? arr.map(u=>`<a target="_blank" href="${u}">üìé ${label}</a>`).join('<br>') : '‚Äî';

      $('mBody').innerHTML = `
        <div style="text-align:center;margin:8px 0 12px">
          ${foto.length ? `<img src="${foto[0]}" style="max-width:120px;border-radius:10px;border:3px solid #667eea">` : 'üìÑ'}
        </div>

        <h2 style="text-align:center;margin:0 0 6px">${s.nombre}</h2>
        <div style="text-align:center;margin-bottom:14px">
          <span class="chip ${cls(s.estadoUI)}" style="font-size:14px"> ${s.estadoUI}</span>
        </div>

        <div style="background:#f8f9fa;padding:14px;border-radius:10px;margin:10px 0">
          <h3 style="margin:0 0 8px;color:#3f51b5">üë§ DATOS PERSONALES</h3>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
            <div><b>Nombres:</b> ${nombres}</div>
            <div><b>Apellidos:</b> ${apellidos}</div>
            <div><b>Documento:</b> ${doc}</div>
            <div><b>Tipo Doc:</b> ${tipoDoc||'‚Äî'}</div>
            <div><b>G√©nero:</b> ${genero||'‚Äî'}</div>
            <div><b>Fecha Nacimiento:</b> ${fnac||'‚Äî'}</div>
            <div><b>Edad:</b> ${edad||'‚Äî'}</div>
            <div><b>RH:</b> ${rh||'‚Äî'}</div>
            <div><b>Email:</b> ${email||'‚Äî'}</div>
            <div><b>Celular:</b> ${cel||'‚Äî'}</div>
          </div>
        </div>

        <div style="background:#e3f2fd;padding:14px;border-radius:10px;margin:10px 0">
          <h3 style="margin:0 0 8px;color:#1976d2">üéì INFORMACI√ìN ACAD√âMICA</h3>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
            <div><b>Grado a Inscribir:</b> ${grado}¬∞</div>
            <div><b>Sede:</b> ${sede}</div>
            <div><b>Jornada:</b> ${jornada}</div>
            <div><b>ID √önico:</b> ${idUnico}</div>
          </div>
        </div>

        <div style="background:#f3e5f5;padding:14px;border-radius:10px;margin:10px 0">
          <h3 style="margin:0 0 8px;color:#7b1fa2">üìû INFORMACI√ìN DE CONTACTO</h3>
          <div><b>Direcci√≥n:</b> ${dir||'‚Äî'}</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px">
            <div><b>Barrio:</b> ${barrio||'‚Äî'}</div>
            <div><b>Ciudad:</b> ${ciudad||'‚Äî'}</div>
            <div><b>Estrato:</b> ${estrato||'‚Äî'}</div>
          </div>
        </div>

        <div style="background:#e8f5e9;padding:14px;border-radius:10px;margin:10px 0">
          <h3 style="margin:0 0 8px;color:#2e7d32">üë®‚Äçüë©‚Äçüëß ACUDIENTE</h3>
          <div><b>Nombre:</b> ${acudiente||'‚Äî'}</div>
          <div><b>Documento:</b> ${docAcud||'‚Äî'}</div>
          <div><b>Tel:</b> ${telAcud||'‚Äî'}</div>
          <div><b>Email:</b> ${emailAcud||'‚Äî'}</div>
          <div><b>Parentesco:</b> ${parentesc||'‚Äî'}</div>
        </div>

        <div style="background:#fff3e0;padding:14px;border-radius:10px;margin:10px 0">
          <h3 style="margin:0 0 8px;color:#e65100">üë®‚Äçüë©‚Äçüë¶ PADRES</h3>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
            <div><b>Madre:</b> ${madreNom||'‚Äî'} <b>Cel:</b> ${madreCel||'‚Äî'}</div>
            <div><b>Padre:</b> ${padreNom||'‚Äî'} <b>Cel:</b> ${padreCel||'‚Äî'}</div>
          </div>
        </div>

        <div style="background:#fce4ec;padding:14px;border-radius:10px;margin:10px 0">
          <h3 style="margin:0 0 8px;color:#c2185b">üè• M√âDICA / SOCIAL</h3>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
            <div><b>EPS/IPS:</b> ${eps||'‚Äî'}</div>
            <div><b>Sisb√©n:</b> ${sisben||'‚Äî'}</div>
            <div><b>Etnia:</b> ${etnia||'‚Äî'}</div>
            <div><b>Discapacidad:</b> ${disca||'‚Äî'}</div>
            <div><b>Desplazado:</b> ${despl||'‚Äî'}</div>
          </div>
        </div>

        <div style="background:#fff9c4;padding:14px;border-radius:10px;margin:10px 0;border:2px solid #f9a825">
          <h3 style="margin:0 0 8px;color:#f57c00">üìé DOCUMENTOS ADJUNTOS</h3>
          <div style="margin:6px 0"><b>Foto(s):</b><br>${linkList(foto,'Foto')}</div>
          <div style="margin:6px 0"><b>Bolet√≠n(es):</b><br>${linkList(boletin,'Bolet√≠n')}</div>
          <div style="margin:6px 0"><b>Documento(s) de identidad:</b><br>${linkList(docIdent,'Documento')}</div>
        </div>

        ${obs ? `<div style="background:#e1f5fe;padding:14px;border-radius:10px;margin:10px 0">
          <h3 style="margin:0 0 8px;color:#0277bd">üìù OBSERVACIONES</h3>${obs}
        </div>` : ''}

        <div style="text-align:center;margin-top:10px;color:#6b7280">
          <b>ID de env√≠o:</b> ${s.submissionId}
        </div>
      `;
      $('modal').style.display='block';
    }
    $('mClose').onclick = ()=> $('modal').style.display='none';
    window.onclick = e => { if(e.target===$('modal')) $('modal').style.display='none'; };

    // === MASIVO ===
    $('chkAll').onclick = (e)=> document.querySelectorAll('.rowchk').forEach(c=> c.checked = e.target.checked);
    async function bulk(estado){
      const ids = [...document.querySelectorAll('.rowchk:checked')].map(c=>c.dataset.id);
      if(ids.length===0){ note('No hay seleccionados','error'); return; }
      for(const id of ids){
        const idx = view.findIndex(x=>x.submissionId===id);
        if(idx>=0) await act(idx, estado);
      }
      note(`Listo: ${estado} (${ids.length})`,'success');
    }

    // === EXPORTAR EXCEL ===
    function exportarExcel(){
      if(view.length===0){ note('No hay datos','error'); return; }
      const data = view.map(s=>({
        Nombre: s.nombre,
        Documento: s.documento,
        Grado: s.grado,
        Sede: s.sede,
        Jornada: s.jornada,
        Estado_UI: s.estadoUI,
        Estado_JF: s.estadoJF || ''
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Estudiantes");
      XLSX.writeFile(wb, "estudiantes.xlsx");
    }

    // === Listeners UI ===
    $('busca').oninput  = render;
    $('sedeF').onchange = render;
    $('gradoF').onchange = render;
    $('estadoF').onchange = render;
    $('sync').onclick   = ()=>{ note('Sincronizando‚Ä¶','info'); sync(); };
    $('bulkOk').onclick = ()=> bulk('Aprobar');
    $('bulkBad').onclick = ()=> bulk('Rechazar');
    $('bulkRev').onclick = ()=> bulk('Pendiente');
    $('export').onclick = exportarExcel;

    async function bootAfterLogin(){
      $('userBadge').textContent = (CURRENT_ROLE()||ROLES.admin).name;
      await loadFormId();
      await sync();
      setInterval(sync, 180000);
    }

    // Arranque
    document.addEventListener('DOMContentLoaded', async ()=>{
      if(CURRENT_ROLE_KEY){ $('userBadge').textContent = ROLES[CURRENT_ROLE_KEY].name; hideLogin(); await bootAfterLogin(); }
      else { showLogin(); }
    });
  </script>
</body>
</html>
