<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Colegio T√©cnico Vicente Azuero ‚Äî Aprobaciones</title>
<style>
  :root{
    --indigo:#4f46e5; --indigo-600:#4f46e5; --indigo-500:#6366f1; --indigo-400:#818cf8;
    --blue-50:#eff6ff; --blue-100:#dbeafe; --blue-200:#bfdbfe; --blue-700:#1d4ed8;
    --slate-50:#f8fafc; --slate-100:#f1f5f9; --slate-200:#e2e8f0; --slate-700:#334155;
    --emerald:#10b981; --red:#ef4444; --amber:#f59e0b; --zinc-100:#f4f4f5;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color:#0f172a;
  }
  .wrap{max-width:1200px;margin:24px auto;padding:16px;background:#fff;border-radius:18px;
        box-shadow:0 18px 36px rgba(0,0,0,.15)}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{font-size:24px;margin:0;font-weight:800}
  .role{background:#eef2ff;color:#1d4ed8;border:1px solid #e0e7ff;padding:6px 10px;border-radius:20px}
  .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:10px;padding:10px 14px;
       font-weight:600; cursor:pointer}
  .btn.sync{background:#e0e7ff;color:#1d4ed8}
  .btn.xls{background:#d1fae5;color:#065f46}
  .btn.approve{background:#10b981;color:#fff}
  .btn.reject{background:#ef4444;color:#fff}
  .btn.reverse{background:#475569;color:#fff}
  .btn.logout{background:#ef4444;color:#fff}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin:16px 0}
  .stat{background:#f8fafc;border:1px solid #e5e7eb;border-radius:14px;padding:14px;text-align:center}
  .stat .n{font-size:26px;font-weight:800;color:#1d4ed8}
  .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:8px}
  select,input[type="text"]{padding:10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  thead th{font-size:13px;text-transform:uppercase;color:#475569;background:#f1f5ff;border-bottom:1px solid #e5e7eb;padding:10px;text-align:left}
  tbody td{border-bottom:1px solid #f1f5f9;padding:10px;vertical-align:top}
  tbody tr:hover{background:#f8fafc}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:16px;border:1px solid #e5e7eb;background:#f8fafc;color:#334155;font-size:12px}
  .chip.ok{background:#d1fae5;border-color:#a7f3d0;color:#065f46}
  .chip.warn{background:#fef9c3;border-color:#fde68a;color:#854d0e}
  .chip.bad{background:#fee2e2;border-color:#fecaca;color:#991b1b}
  .chip.tag{background:#eef2ff;border-color:#e0e7ff}
  .actions .btn-sm{padding:6px 10px;border-radius:8px;border:0;cursor:pointer}
  .btn-info{background:#0ea5e9;color:#fff}
  .btn-ok{background:#10b981;color:#fff}
  .btn-bad{background:#ef4444;color:#fff}
  .btn-lock{background:#94a3b8;color:#fff}
  .center{display:flex;justify-content:center;align-items:center;padding:24px}
  /* ===== FICHA (modal) ===== */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
  .modal{position:fixed;inset:0;display:none;z-index:1001}
  .modal-card{background:#fff;border-radius:16px;max-width:980px;margin:40px auto;padding:18px 22px;
              max-height:86vh;overflow:auto;border:1px solid #e5e7eb}
  .headline{display:flex;align-items:center;gap:14px;border-bottom:1px solid #e5e7eb;padding-bottom:10px;margin-bottom:12px}
  .avatar{width:86px;height:86px;border-radius:999px;object-fit:cover;border:3px solid #667eea;background:#f0f3ff}
  .title-xl{font-size:22px;font-weight:800;margin:0}
  .subchips{display:flex;gap:8px;align-items:center}
  .section{border-radius:12px;padding:14px 16px;margin:12px 0;border:1px solid #e5e7eb;background:#fff}
  .section.blue{background:#f1f5ff;border-color:#dbe4ff}
  .section.indigo{background:#eef2ff;border-color:#e0e7ff}
  .section.slate{background:#f8fafc;border-color:#e5e7eb}
  .link-list a{display:inline-block;margin:4px 8px 4px 0;text-decoration:none}
  .embed-box{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:8px}
  /* ===== Login ===== */
  .login{max-width:430px;margin:60px auto;background:#fff;border-radius:16px;padding:20px;
         border:1px solid #e5e7eb;box-shadow:0 14px 28px rgba(0,0,0,.12)}
  .login h2{margin:0 0 10px}
  .role-box{display:flex;flex-direction:column;gap:8px;margin:10px 0}
  .role-item{display:flex;align-items:center;justify-content:space-between;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .role-item input{width:140px;padding:8px;border-radius:8px;border:1px solid #e5e7eb}
  .muted{color:#64748b;font-size:13px}
</style>
</head>
<body>

<div id="login" class="login">
  <h2>Acceso ‚Äì Aprobaciones</h2>
  <p class="muted">Elija su rol y digite la contrase√±a asignada.</p>

  <div id="roles" class="role-box"></div>

  <button id="btnLogin" class="btn approve" style="width:100%;margin-top:8px">Ingresar</button>
  <p class="muted" style="margin-top:12px">Administrador y Coordinadores: si necesita cambiar contrase√±as me avisa y lo dejo en configuraci√≥n.</p>
</div>

<div id="app" class="wrap" style="display:none">
  <header>
    <h1>Colegio T√©cnico Vicente Azuero ‚Äî Aprobaciones</h1>
    <div>
      <span id="who" class="role">‚Äî</span>
      <button id="logout" class="btn logout">Cerrar sesi√≥n</button>
    </div>
  </header>

  <div class="filters" style="gap:8px;margin-bottom:12px">
    <button id="sync" class="btn sync">üîÑ Sincronizar</button>
    <button id="xport" class="btn xls">üì• Exportar Excel</button>
    <button id="apSel" class="btn approve">‚úÖ Aprobar seleccionados</button>
    <button id="reSel" class="btn reject">‚ùå Rechazar seleccionados</button>
    <button id="rvSel" class="btn reverse">‚Ü©Ô∏é Reversar seleccionados</button>
  </div>

  <div class="stats">
    <div class="stat"><div class="n" id="sTot">0</div><div>Total estudiantes</div></div>
    <div class="stat"><div class="n" id="sPen">0</div><div>Pendientes</div></div>
    <div class="stat"><div class="n" id="sApr">0</div><div>Aprobados</div></div>
    <div class="stat"><div class="n" id="sRej">0</div><div>Rechazados</div></div>
  </div>

  <div class="filters">
    <select id="fSede"></select>
    <select id="fGrado"></select>
    <select id="fEstado"></select>
    <input id="fBuscar" type="text" placeholder="Buscar estudiante o documento‚Ä¶" />
  </div>

  <div id="loading" class="center">Cargando‚Ä¶</div>
  <table style="display:none" id="tbl">
    <thead>
      <tr>
        <th style="width:36px"><input type="checkbox" id="chkAll"></th>
        <th>Nombre</th><th>Documento</th><th>Grado</th><th>Sede</th><th>Jornada</th>
        <th>Estado</th><th style="width:210px">Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- Backdrop + Modal Ficha -->
<div id="backdrop" class="backdrop"></div>
<div id="modal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:flex-end">
      <button onclick="closeModal()" class="btn reverse" style="padding:6px 10px">Cerrar √ó</button>
    </div>
    <div id="mBody"></div>
  </div>
</div>

<script>
/* =======================
   ROLES (con contrase√±a)
   ======================= */
const SEDE_MAP = {
  'Sede A':'Colegio Tecnico Vicente Azuero - Lagos 2',
  'Sede B':'Instituto Andres Bello - Lagos 1',
  'Sede C':'Instituto Juan Pablo I - Lagos 2',
  'Sede D':'Colegio Tecnico Vicente Azuero - Principal'
};
// Ajusta nombres si tu texto en Jotform difiere

const ROLES = {
  admin:        { name:'Administrador', pass:'admin123', canAll:true },
  sedeA_m:      { name:'Sede A ‚Äì Ma√±ana', pass:'aM2024', sede:SEDE_MAP['Sede A'], jornada:'Ma√±ana' },
  sedeA_t:      { name:'Sede A ‚Äì Tarde',  pass:'aT2024', sede:SEDE_MAP['Sede A'], jornada:'Tarde' },
  sedeB:        { name:'Sede B',          pass:'b2024',  sede:SEDE_MAP['Sede B'] },
  sedeC:        { name:'Sede C',          pass:'c2024',  sede:SEDE_MAP['Sede C'] },
  sedeD:        { name:'Sede D',          pass:'d2024',  sede:SEDE_MAP['Sede D'] },
};

let currentRoleId = null;
let rawList = [];     // submissions crudas
let all = [];         // mapeo
let view = [];        // vista filtrada actual

const ESTADOS_UI = ['Pendiente','En Progreso','Aprobado','Rechazado','Solicitar Documentos','Bloqueado'];
const ESTADO_CLASS = s => s==='Aprobado' ? 'chip ok' : s==='Rechazado' ? 'chip bad' : s==='Solicitar Documentos' ? 'chip warn' : 'chip';

// utils
const $ = id => document.getElementById(id);
function fmt(v){return v ?? ''}

// ====== LOGIN ======
(function paintRoles(){
  const box = $('roles');
  box.innerHTML = '';
  Object.entries(ROLES).forEach(([id, r])=>{
    const row = document.createElement('div');
    row.className='role-item';
    row.innerHTML = `<div>${r.name}</div>
      <div>
        <input type="password" id="pwd_${id}" placeholder="Contrase√±a">
        <button class="btn approve" onclick="pickRole('${id}')">Elegir</button>
      </div>`;
    box.appendChild(row);
  });
})();

function pickRole(id){
  currentRoleId = id;
  [...document.querySelectorAll('.role-item')].forEach(x => x.style.outline='');
  $('pwd_'+id).focus();
}
$('btnLogin').onclick = () => {
  if(!currentRoleId){ alert('Seleccione un rol.'); return; }
  const pwd = $('pwd_'+currentRoleId).value.trim();
  if(pwd !== ROLES[currentRoleId].pass){ alert('Contrase√±a incorrecta.'); return; }
  $('login').style.display='none';
  $('app').style.display='block';
  $('who').textContent = ROLES[currentRoleId].name;
  sync();
};
$('logout').onclick = () => { location.reload(); };

// ====== FILTROS UI ======
const sedesOpt = ['', SEDE_MAP['Sede A'], SEDE_MAP['Sede B'], SEDE_MAP['Sede C'], SEDE_MAP['Sede D']];
const gradosOpt = ['', '1','2','3','4','5','6','7','8','9','10','11'];
function fillSelect(sel, options, label){
  sel.innerHTML = '';
  options.forEach(v=>{
    const op = document.createElement('option');
    op.value = v;
    op.textContent = v ? v : `Todos ${label}`;
    sel.appendChild(op);
  });
}
fillSelect($('fSede'), sedesOpt, 'las Sedes');
fillSelect($('fGrado'), gradosOpt, 'los Grados');
fillSelect($('fEstado'), ['', ...ESTADOS_UI], 'los Estados');

$('fSede').onchange = $('fGrado').onchange = $('fEstado').onchange = $('fBuscar').oninput = applyFilters;

// ====== SYNC (usa tu endpoint serverless) ======
$('sync').onclick = sync;

async function sync(){
  $('tbl').style.display='none';
  $('loading').style.display='flex';
  try{
    // Tu serverless debe devolver tal cual la respuesta de Jotform: { content: [ ... ] }
    const r = await fetch('/api/jotform/list');
    if(!r.ok) throw new Error('No se pudo leer /api/jotform/list');
    const data = await r.json();
    rawList = data.content || [];

    // Cargar cambios locales (si quieres conservar reversa offline)
    const local = JSON.parse(localStorage.getItem('local_changes')||'{}');

    all = rawList.map(s => mapSubmission(s, local));
    applyFilters();
  }catch(e){
    console.error(e);
    alert('No pude sincronizar. Revisa el endpoint /api/jotform/list o la consola.');
    $('loading').style.display='none';
  }
}

function mapSubmission(s, local){
  const a = s.answers || s.answer || s?.raw?.a || {};
  // Helpers por etiqueta
  const byLabel = (keys, fb='') => {
    const arr = Array.isArray(keys)?keys:[keys];
    const hit = Object.values(a).find(x=>{
      const t = (x?.text||'').toLowerCase();
      return arr.every(k => t.includes(k.toLowerCase()));
    });
    return hit?.answer || hit?.prettyFormat || fb;
  };
  // Adjuntos
  const toUrls = (v)=> {
    if(!v) return [];
    if(Array.isArray(v)) return v.filter(Boolean);
    if(typeof v==='string') return v.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
    return [];
  };

  const nombres   = byLabel(['nombres','nombre']);
  const apellidos = byLabel(['apellidos','apellido']);
  const nombre    = (nombres + ' ' + apellidos).trim() || 'Sin nombre';
  const documento = byLabel(['documento','doc']);
  const grado     = byLabel(['grado']);
  const sede      = byLabel(['sede']);
  const jornada   = byLabel(['jornada']);

  // Estado desde ‚ÄúEstado de Aprobaci√≥n‚Äù
  let estadoJF   = byLabel(['estado de aprobaci√≥n','estado','aprobaci√≥n']);
  if(!estadoJF) estadoJF = s.flowStatus || '';

  // Normalizar a UI
  let estadoUI = 'Pendiente';
  const low = (estadoJF||'').toLowerCase();
  if(low.includes('aproba')) estadoUI='Aprobado';
  else if(low.includes('rechaz')) estadoUI='Rechazado';
  else if(low.includes('solicit')) estadoUI='Solicitar Documentos';
  else if(low.includes('bloque')) estadoUI='Bloqueado';
  else if(low.includes('progre')) estadoUI='En Progreso';

  // Aplicar override local si existe
  if(local[s.id]?.estadoUI) estadoUI = local[s.id].estadoUI;

  // Adjuntos posibles
  const boletin = toUrls(byLabel(['bolet√≠n','boletin']) || a['61']?.answer);
  const docid   = toUrls(byLabel(['documento de identidad','identidad']) || a['62']?.answer);
  const foto    = toUrls(byLabel(['foto']) || a['73']?.answer);

  return {
    submissionId: s.id,
    createdAt: s.created_at,
    raw:{s, a},
    nombre, documento, grado, sede, jornada,
    estadoUI,
    adjuntos:{boletin, docid, foto}
  };
}

function applyFilters(){
  const role = ROLES[currentRoleId];
  const sedeF = $('fSede').value;
  const gradoF = $('fGrado').value;
  const estadoF = $('fEstado').value;
  const q = $('fBuscar').value.toLowerCase();

  // Base: seg√∫n rol
  let base = role.canAll ? all.slice() : all.filter(s=>{
    const sedeOK = role.sede ? s.sede===role.sede : true;
    const jorOK  = role.jornada ? s.jornada===role.jornada : true;
    return sedeOK && jorOK;
  });

  // Filtros UI
  if(sedeF) base = base.filter(s=> s.sede===sedeF);
  if(gradoF) base = base.filter(s=> s.grado==gradoF);
  if(estadoF) base = base.filter(s=> s.estadoUI===estadoF);
  if(q) base = base.filter(s=> (s.nombre||'').toLowerCase().includes(q) || (s.documento||'').includes(q));

  view = base;
  paintTable();
  updateStats();
}

function paintTable(){
  const tb = $('tbody');
  tb.innerHTML = '';
  view.forEach((s, i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="chk" data-i="${i}"></td>
      <td>${fmt(s.nombre)}</td>
      <td>${fmt(s.documento)}</td>
      <td>${fmt(s.grado)}¬∞</td>
      <td>${fmt(s.sede)}</td>
      <td>${fmt(s.jornada)}</td>
      <td><span class="${ESTADO_CLASS(s.estadoUI)}">${s.estadoUI}</span></td>
      <td class="actions">
        <button class="btn-sm btn-info" onclick="ver(${i})">Ver</button>
        <button class="btn-sm btn-ok" onclick="cambiarEstado(${i}, 'Aprobado')">‚úì</button>
        <button class="btn-sm btn-bad" onclick="cambiarEstado(${i}, 'Rechazado')">‚úï</button>
        <button class="btn-sm btn-lock" onclick="cambiarEstado(${i}, 'Bloqueado')">üîí</button>
      </td>`;
    tb.appendChild(tr);
  });
  $('loading').style.display='none';
  $('tbl').style.display='table';
  $('chkAll').checked=false;
}

function updateStats(){
  const tot=view.length;
  const pen=view.filter(s=> s.estadoUI==='Pendiente'||s.estadoUI==='En Progreso').length;
  const apr=view.filter(s=> s.estadoUI==='Aprobado').length;
  const rej=view.filter(s=> s.estadoUI==='Rechazado').length;
  $('sTot').textContent=tot; $('sPen').textContent=pen; $('sApr').textContent=apr; $('sRej').textContent=rej;
}

// ====== Exportar Excel (.xls compatible) ======
$('xport').onclick = ()=>{
  // Construimos una tabla m√≠nima HTML y la servimos como .xls
  let html = `<table border="1"><thead><tr>
  <th>Nombre</th><th>Documento</th><th>Grado</th><th>Sede</th><th>Jornada</th><th>Estado</th></tr></thead><tbody>`;
  view.forEach(s=>{
    html += `<tr><td>${fmt(s.nombre)}</td><td>${fmt(s.documento)}</td><td>${fmt(s.grado)}</td>
    <td>${fmt(s.sede)}</td><td>${fmt(s.jornada)}</td><td>${fmt(s.estadoUI)}</td></tr>`;
  });
  html += `</tbody></table>`;
  const blob = new Blob([`\ufeff`+html], {type:'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='estudiantes.xls'; a.click();
  URL.revokeObjectURL(url);
};

// ====== Selecci√≥n masiva ======
$('chkAll').onchange = e=>{
  document.querySelectorAll('.chk').forEach(ch=> ch.checked = e.target.checked);
};
$('apSel').onclick = ()=> bulk('Aprobado');
$('reSel').onclick = ()=> bulk('Rechazado');
$('rvSel').onclick = ()=> bulk('Pendiente');

function bulk(estado){
  const idx = [...document.querySelectorAll('.chk')].filter(c=>c.checked).map(c=> parseInt(c.dataset.i));
  if(!idx.length) return alert('Selecciona al menos un estudiante.');
  idx.forEach(i=> cambiarEstado(i, estado, true));
  alert('Se enviaron las actualizaciones. Si alguna falla, revisa la consola.');
}

// ====== UPDATE estado (usa tu /api/jotform/update) ======
async function cambiarEstado(i, nuevo, silent=false){
  const s = view[i];
  try{
    const r = await fetch('/api/jotform/update', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ submissionId: s.submissionId, estado: nuevo })
    });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok){
      if(!silent) alert('Error actualizando en Jotform: '+(j?.message||r.status));
      console.warn('Proxy ‚Üí', j);
      return;
    }
    // guarda cambio local para que persista aunque resync
    const local = JSON.parse(localStorage.getItem('local_changes')||'{}');
    local[s.submissionId] = {estadoUI:nuevo, fecha: new Date().toISOString()};
    localStorage.setItem('local_changes', JSON.stringify(local));

    // reflejar en la vista actual
    s.estadoUI = nuevo;
    paintTable(); updateStats();
  }catch(e){
    if(!silent) alert('No se pudo actualizar. Revisa consola.');
    console.error(e);
  }
}

// ====== Detalle (ficha) ======
const backdrop = $('backdrop'); const modal = $('modal');
function closeModal(){ backdrop.style.display='none'; modal.style.display='none'; }

function jotformPdfUrl(submissionId){ return `https://www.jotform.com/pdf-submission/${submissionId}`; }

function getByLabel(keys, answers, fb=''){
  const arr = Array.isArray(keys)?keys:[keys];
  const hit = Object.values(answers).find(x=>{
    const t=(x?.text||'').toLowerCase();
    return arr.every(k=> t.includes(k.toLowerCase()));
  });
  return hit?.answer || hit?.prettyFormat || fb;
}
function urlsFrom(answer){
  if(!answer) return [];
  if(Array.isArray(answer)) return answer.filter(Boolean);
  if(typeof answer==='string') return answer.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  return [];
}

function ver(i){
  const s = view[i];
  const a = s.raw?.a || s.raw?.s?.answers || {};

  const nombres    = getByLabel(['nombres','nombre'], a, '');
  const apellidos  = getByLabel(['apellidos','apellido'], a, '');
  const tipoDoc    = getByLabel(['tipo','doc'], a, '');
  const genero     = getByLabel(['g√©nero','genero'], a, '');
  const fnacimiento= getByLabel(['fecha','nacimiento'], a, '');     // corregido
  const rh         = getByLabel(['rh','grupo'], a, '');
  const edad       = getByLabel(['edad'], a, '');

  const email      = getByLabel(['email','correo'], a, '') || a['22']?.answer || a['17']?.answer || '';
  const celular    = getByLabel(['celular','tel','telefono'], a, '') || a['21']?.answer || a['29']?.answer || '';
  const direccion  = getByLabel(['direcci√≥n','direccion'], a, '');
  const barrio     = getByLabel(['barrio'], a, '');
  const ciudad     = getByLabel(['ciudad'], a, '');
  const estrato    = getByLabel(['estrato'], a, '');

  const grado      = s.grado || getByLabel(['grado'], a, '‚Äî');
  const sede       = s.sede  || getByLabel(['sede'], a, '‚Äî');
  const jornada    = s.jornada || getByLabel(['jornada'], a, '‚Äî');
  const idUnico    = getByLabel(['id','√∫nico','unico'], a, 'No asignado'); // corregido

  const acudiente  = getByLabel(['acudiente','responsable'], a, '');
  const docAcud    = getByLabel(['documento','acudiente'], a, '');
  const telAcud    = getByLabel(['tel','acudiente'], a, '');
  const emailAcud  = getByLabel(['email','acudiente'], a, '');
  const parentesco = getByLabel(['parentesco'], a, '');

  const madreNom   = getByLabel(['nombre','madre'], a, '');
  const madreCel   = getByLabel(['celular','madre'], a, '');
  const padreNom   = getByLabel(['nombre','padre'], a, '');
  const padreCel   = getByLabel(['celular','padre'], a, '');

  const eps        = getByLabel(['eps','ips'], a, '');
  const sisben     = getByLabel(['sisben','sisb√©n'], a, '');
  const etnia      = getByLabel(['etnia'], a, '');
  const discapacidad = getByLabel(['discapacidad'], a, 'Ninguna');
  const desplazado   = getByLabel(['desplazado'], a, 'No');

  const boletines = urlsFrom( getByLabel(['bolet√≠n','boletin'], a) || a['61']?.answer );
  const documentos = urlsFrom( getByLabel(['documento de identidad','identidad'], a) || a['62']?.answer );
  const fotos = urlsFrom( getByLabel(['foto'], a) || a['73']?.answer );

  const obs       = getByLabel(['observaciones','observaci√≥n','observacion'], a, '');

  const avatar = fotos[0] ? `<img src="${fotos[0]}" class="avatar">`
                          : `<div class="avatar" style="display:flex;align-items:center;justify-content:center;font-size:26px; color:#667eea">üë§</div>`;
  const estadoChip = `<span class="${ESTADO_CLASS(s.estadoUI)}" style="font-size:13px">${s.estadoUI}</span>`;
  const pdfUrl = jotformPdfUrl(s.submissionId);

  $('mBody').innerHTML = `
    <div class="headline">
      ${avatar}
      <div>
        <div class="title-xl">${fmt((nombres+' '+apellidos).trim() || s.nombre)}</div>
        <div class="subchips">
          ${estadoChip}
          <span class="chip tag">Documento: ${fmt(s.documento)}</span>
        </div>
      </div>
    </div>

    <div class="section slate">
      <h3 style="margin:0 0 8px;color:#0f172a">üë§ DATOS PERSONALES</h3>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
        <div><b>Nombres:</b> ${fmt(nombres)}</div>
        <div><b>Apellidos:</b> ${fmt(apellidos)}</div>
        <div><b>Tipo Doc:</b> ${fmt(tipoDoc)}</div>
        <div><b>G√©nero:</b> ${fmt(genero)}</div>
        <div><b>Fecha Nacimiento:</b> ${fmt(fnacimiento)}</div>
        <div><b>Edad:</b> ${fmt(edad)}</div>
        <div><b>RH:</b> ${fmt(rh)}</div>
        <div><b>Email:</b> ${fmt(email)}</div>
        <div><b>Celular:</b> ${fmt(celular)}</div>
      </div>
    </div>

    <div class="section blue">
      <h3 style="margin:0 0 8px;color:#1d4ed8">üéì INFORMACI√ìN ACAD√âMICA</h3>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
        <div><b>Grado a Inscribir:</b> ${fmt(grado)}¬∞</div>
        <div><b>Sede:</b> ${fmt(sede)}</div>
        <div><b>Jornada:</b> ${fmt(jornada)}</div>
        <div><b>ID √önico:</b> ${fmt(idUnico)}</div>
      </div>
    </div>

    <div class="section indigo">
      <h3 style="margin:0 0 8px;color:#3730a3">üìû INFORMACI√ìN DE CONTACTO</h3>
      <div><b>Direcci√≥n:</b> ${fmt(direccion)}</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px">
        <div><b>Barrio:</b> ${fmt(barrio)}</div>
        <div><b>Ciudad:</b> ${fmt(ciudad)}</div>
        <div><b>Estrato:</b> ${fmt(estrato)}</div>
      </div>
    </div>

    <div class="section slate">
      <h3 style="margin:0 0 8px;color:#0f172a">üë®‚Äçüë©‚Äçüëß ACUDIENTE</h3>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
        <div><b>Nombre:</b> ${fmt(acudiente)}</div>
        <div><b>Parentesco:</b> ${fmt(parentesco)}</div>
        <div><b>Documento:</b> ${fmt(docAcud)}</div>
        <div><b>Tel√©fono:</b> ${fmt(telAcud)}</div>
        <div><b>Email:</b> ${fmt(emailAcud)}</div>
      </div>
    </div>

    <div class="section blue">
      <h3 style="margin:0 0 8px;color:#1d4ed8">üë®‚Äçüë©‚Äçüë¶ PADRES</h3>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
        <div><b>Madre:</b> ${fmt(madreNom)} ‚Äî <b>Cel:</b> ${fmt(madreCel)}</div>
        <div><b>Padre:</b> ${fmt(padreNom)} ‚Äî <b>Cel:</b> ${fmt(padreCel)}</div>
      </div>
    </div>

    <div class="section indigo">
      <h3 style="margin:0 0 8px;color:#3730a3">üè• M√âDICA / SOCIAL</h3>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
        <div><b>EPS/IPS:</b> ${fmt(eps)}</div>
        <div><b>Sisb√©n:</b> ${fmt(sisben)}</div>
        <div><b>Etnia:</b> ${fmt(etnia)}</div>
        <div><b>Discapacidad:</b> ${fmt(discapacidad)}</div>
        <div><b>Desplazado:</b> ${fmt(desplazado)}</div>
      </div>
    </div>

    <div class="section slate">
      <h3 style="margin:0 0 8px;color:#0f172a">üìé ARCHIVOS DEL ESTUDIANTE</h3>
      <div class="link-list" style="margin-bottom:6px">
        <b>Bolet√≠n:</b>
        ${s.adjuntos.boletin.length ? s.adjuntos.boletin.map(u=>`<a target="_blank" href="${u}">üìÑ Ver</a>`).join('') : ' ‚Äî'}
      </div>
      <div class="link-list" style="margin-bottom:6px">
        <b>Documento de identidad:</b>
        ${s.adjuntos.docid.length ? s.adjuntos.docid.map(u=>`<a target="_blank" href="${u}">üÜî Ver</a>`).join('') : ' ‚Äî'}
      </div>

      <div style="margin-top:8px">
        <b>PDF de la inscripci√≥n:</b>
        <a target="_blank" href="${pdfUrl}">Abrir / Descargar</a>
      </div>
      <div class="embed-box" style="margin-top:8px">
        <iframe src="${pdfUrl}" style="width:100%;height:420px;border:0" loading="lazy"></iframe>
      </div>
    </div>

    ${obs ? `<div class="section indigo"><h3 style="margin:0 0 8px;color:#3730a3">üìù OBSERVACIONES</h3>${obs}</div>` : ''}

    <div style="text-align:center;margin-top:10px;color:#6b7280">
      <b>ID de env√≠o:</b> ${s.submissionId}
    </div>
  `;
  backdrop.style.display='block'; modal.style.display='block';
}
</script>
</body>
</html>
