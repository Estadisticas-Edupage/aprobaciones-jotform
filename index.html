<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Inscripciones – Aprobaciones</title>
  <style>
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;font-family:Segoe UI,Tahoma,Verdana,sans-serif}
    .container{max-width:1400px;margin:0 auto}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);overflow:hidden}
    .header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px}
    .title{font-size:20px;font-weight:700}
    .badge{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:999px;padding:6px 12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:16px 0}
    .stat{background:#fff;border-radius:12px;padding:16px;text-align:center}
    .stat .n{font-size:32px;font-weight:800;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .panel{background:#fff;border-radius:16px;margin-top:16px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,input,button{padding:10px;border-radius:10px;border:2px solid #e5e7eb;font-size:14px}
    button{background:#667eea;color:#fff;border:none;cursor:pointer} button:hover{opacity:.9}
    .table{overflow:auto;border-radius:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;border-bottom:1px solid #f1f5f9}
    th{background:#f8fafc;font-weight:700}
    .chip{display:inline-block;font-size:12px;padding:5px 10px;border-radius:999px;border:1px solid #e5e7eb;margin-right:6px}
    .ok{background:#d4edda;color:#155724;border-color:#c3e6cb}
    .warn{background:#fff3cd;color:#856404;border-color:#ffe69c}
    .bad{background:#f8d7da;color:#721c24;border-color:#f5c6cb}
    .info{background:#e3f2fd;color:#1976d2;border-color:#bbdefb}
    .muted{background:#eee;color:#444;border-color:#ddd}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn-ok{background:#28a745} .btn-bad{background:#dc3545} .btn-doc{background:#ff9800} .btn-lock{background:#9e9e9e}
    .btn-rev{background:#6b7280}
    .note{position:fixed;right:20px;top:20px;padding:12px 16px;border-radius:10px;color:#fff;display:none;box-shadow:0 10px 20px rgba(0,0,0,.2)}
    .note.success{background:#16a34a} .note.error{background:#dc2626} .note.info{background:#0284c7}
    @media(max-width:768px){th,td{padding:10px 8px;font-size:12px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">🎓 Inscripciones – Aprobaciones</div>
        <div class="badge" id="userBadge">Invitado</div>
      </div>

      <!-- Config -->
      <div class="panel">
        <div class="row">
          <input id="apiKey" placeholder="API Key Jotform">
          <input id="formId" placeholder="Form ID">
          <button id="saveCfg">Guardar</button>
          <button id="sync">Sincronizar</button>
          <button id="clearCache">Limpiar caché local</button>
        </div>
        <small style="color:#6b7280">Producción: esta app actualiza por <b>proxy</b> para evitar CORS.</small>
      </div>

      <!-- Stats -->
      <div class="grid">
        <div class="stat"><div class="n" id="stTotal">0</div><div>Total</div></div>
        <div class="stat"><div class="n" id="stPend">0</div><div>Pendientes</div></div>
        <div class="stat"><div class="n" id="stOk">0</div><div>Aprobados</div></div>
        <div class="stat"><div class="n" id="stBad">0</div><div>Rechazados</div></div>
      </div>

      <!-- Filtros -->
      <div class="panel">
        <div class="row">
          <select id="sedeF"><option value="">Todas las sedes</option></select>
          <select id="gradoF"><option value="">Todos los grados</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option></select>
          <select id="estadoF"><option value="">Todos</option><option>Pendiente</option><option>En Progreso</option><option>Aprobado</option><option>Rechazado</option><option>Solicitar Documentos</option><option>Bloqueado</option></select>
          <input id="busca" placeholder="Buscar por nombre o documento">
          <button id="export">Exportar CSV</button>
        </div>
      </div>

      <!-- Tabla -->
      <div class="panel table">
        <table>
          <thead>
            <tr>
              <th>Nombre</th><th>Documento</th><th>Grado</th><th>Sede</th><th>Jornada</th>
              <th>Estados</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" style="text-align:center">Sin datos</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="note" class="note"></div>

  <script>
    // ============== CONFIG DEL FRONT ==============
    const PROXY_URL = 'https://TU-PROYECTO.vercel.app/api/jotform/update'; // TODO: pon tu URL de Vercel
    const PROXY_TOKEN = '12345-seguro'; // TODO: si usaste PROXY_SECRET en Vercel

    // Si tu campo “Estado de aprobación” es Dropdown, lista las opciones válidas aquí (respeta tildes/espacios).
    const ALLOWED_STATES = ['Pendiente','Aprobado','Rechazado','Solicitar Documentos','Bloqueado','En Progreso'];

    // ==============================================
    let apiKey = localStorage.getItem('jf_api') || '';
    let formId = localStorage.getItem('jf_form') || '';
    let all = [];   // dataset completo
    let view = [];  // dataset filtrado
    let QID_ESTADO = null; // resuelto por API

    // UI helpers
    const $ = (id)=>document.getElementById(id);
    const note = (msg,type='info')=>{
      const n = $('note'); n.textContent = msg; n.className='note '+type; n.style.display='block'; setTimeout(()=>n.style.display='none',2500);
    };
    const cls = (estado)=>{
      const n = (estado||'').toLowerCase();
      if(n.includes('aproba')) return 'ok';
      if(n.includes('rechaza')) return 'bad';
      if(n.includes('progreso')) return 'info';
      if(n.includes('solicitar')) return 'warn';
      if(n.includes('bloque')) return 'muted';
      return 'warn';
    };

    // Guardar config
    $('saveCfg').onclick = ()=>{
      apiKey = $('apiKey').value.trim();
      formId = $('formId').value.trim();
      localStorage.setItem('jf_api', apiKey);
      localStorage.setItem('jf_form', formId);
      note('Configuración guardada','success');
    };

    // Limpia cache local (si lo usas)
    $('clearCache').onclick = ()=>{
      localStorage.removeItem('jotform_local_changes');
      note('Caché local eliminada','success');
    };

    // Export CSV
    $('export').onclick = ()=>{
      if(view.length===0){ note('No hay datos para exportar','error'); return; }
      let csv = 'Nombre,Documento,Grado,Sede,Jornada,Estado (UI),Estado de aprobación (JF)\n';
      view.forEach(s=>{
        csv += `"${s.nombre}","${s.documento}","${s.grado}","${s.sede}","${s.jornada}","${s.estadoUI}","${s.estadoJF||''}"\n`;
      });
      const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = 'estudiantes.csv'; a.click();
    };

    // Filtros
    $('busca').oninput = render;
    $('sedeF').onchange = render;
    $('gradoF').onchange = render;
    $('estadoF').onchange = render;

    // Sincronizar todo (resuelve QID + trae submissions)
    $('sync').onclick = async ()=>{
      if(!apiKey || !formId){ note('Falta API Key y/o Form ID','error'); return; }
      note('Sincronizando...','info');

      // 1) resolver QID del campo “Estado de aprobación”
      QID_ESTADO = await fetchQuestionsAndGetQID(formId, apiKey, 'Estado de aprobación');
      if(!QID_ESTADO){ note('No encontré el campo "Estado de aprobación"','error'); return; }
      console.log('QID Estado de aprobación =>', QID_ESTADO);

      // 2) traer submissions (con workflow_status por visibilidad)
      const url = `https://api.jotform.com/form/${formId}/submissions?apiKey=${apiKey}&limit=200&addWorkflowStatus=1`;
      const r = await fetch(url);
      const data = await r.json();

      if(!data?.content){ note('Sin envíos','error'); return; }

      // llenar combos de sede únicos
      const sedes = new Set();
      all = data.content.map(sub=>{
        const a = sub.answers || {};
        const nombres = a['4']?.answer || a['4']?.prettyFormat || '';
        const apellidos = a['5']?.answer || a['5']?.prettyFormat || '';
        const sede = a['2']?.answer || '—';
        sedes.add(sede);

        const estadoJF = a[QID_ESTADO]?.answer || '';
        const estadoUI = estadoJF || 'Pendiente'; // UI arranca espejo de JF

        return {
          submissionId: sub.id,
          nombre: `${nombres} ${apellidos}`.trim() || 'Sin nombre',
          documento: a['7']?.answer || 'Sin documento',
          grado: a['8']?.answer || '1',
          sede,
          jornada: a['3']?.answer || '—',
          estadoUI,
          estadoJF, // espejo real en JF
          flowStatus: sub.workflow_status || '', // sólo info
        };
      });

      // pintar sedes
      const sedeSel = $('sedeF'); 
      sedeSel.innerHTML = '<option value="">Todas las sedes</option>' + [...sedes].map(s=>`<option>${s}</option>`).join('');

      render();
      note(`Cargados ${all.length} registros`,'success');
    };

    async function fetchQuestionsAndGetQID(formId, apiKey, label){
      const url = `https://api.jotform.com/form/${formId}/questions?apiKey=${apiKey}`;
      const r = await fetch(url); const data = await r.json();
      const norm = s=>(s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
      const target = norm(label);
      if(!data?.content) return null;
      for(const qid in data.content){ if(norm(data.content[qid]?.text)===target) return qid; }
      for(const qid in data.content){ if(norm(data.content[qid]?.text).includes(target)) return qid; }
      return null;
    }

    function render(){
      const sede = $('sedeF').value;
      const grado = $('gradoF').value;
      const est = $('estadoF').value;
      const q = ($('busca').value||'').toLowerCase();

      view = all.filter(s=>{
        return (!sede || s.sede===sede) &&
               (!grado || s.grado===grado) &&
               (!est || s.estadoUI===est) &&
               (!q || s.nombre.toLowerCase().includes(q) || (s.documento||'').includes(q));
      });

      // stats
      $('stTotal').textContent = view.length;
      $('stPend').textContent  = view.filter(x=>x.estadoUI==='Pendiente' || x.estadoUI==='En Progreso').length;
      $('stOk').textContent    = view.filter(x=>x.estadoUI==='Aprobado').length;
      $('stBad').textContent   = view.filter(x=>x.estadoUI==='Rechazado').length;

      // tabla
      const tb = $('tbody');
      if(view.length===0){ tb.innerHTML = '<tr><td colspan="7" style="text-align:center">Sin resultados</td></tr>'; return; }

      tb.innerHTML = view.map((s,i)=>`
        <tr>
          <td>${s.nombre}</td>
          <td>${s.documento}</td>
          <td>${s.grado}°</td>
          <td>${s.sede}</td>
          <td>${s.jornada}</td>
          <td>
            <span class="chip ${cls(s.estadoUI)}">UI: ${s.estadoUI||'—'}</span>
            <span class="chip ${cls(s.estadoJF||'Pendiente')}">JF: ${s.estadoJF||'—'}</span>
            ${s.flowStatus ? `<span class="chip info">Flow: ${s.flowStatus}</span>`:''}
          </td>
          <td class="actions">
            ${(['Pendiente','En Progreso'].includes(s.estadoUI))? `<button class="btn-ok" onclick="act(${i},'Aprobado')">✅</button>`:''}
            ${(['Pendiente','En Progreso'].includes(s.estadoUI))? `<button class="btn-bad" onclick="act(${i},'Rechazado')">❌</button>`:''}
            ${(['Pendiente','En Progreso'].includes(s.estadoUI))? `<button class="btn-doc" onclick="act(${i},'Solicitar Documentos')">📄</button>`:''}
            ${(['Pendiente','En Progreso'].includes(s.estadoUI))? `<button class="btn-lock" onclick="act(${i},'Bloqueado')">🔒</button>`:''}
            ${(!['Pendiente','En Progreso'].includes(s.estadoUI))? `<button class="btn-rev" onclick="act(${i},'Pendiente')">↩ Reversar</button>`:''}
          </td>
        </tr>
      `).join('');
    }

    // Acción central: cambia estado en JF y refresca UI (incluye verificación)
    async function act(idx, nuevo){
      const row = view[idx];
      const target = all.find(x=>x.submissionId===row.submissionId);
      if(!target) return;

      // Si es dropdown, valida opción exacta
      if(ALLOWED_STATES.length && !ALLOWED_STATES.includes(nuevo)){
        note(`El valor "${nuevo}" no está en las opciones del campo`, 'error'); return;
      }

      // 1) UI optimista
      target.estadoUI = nuevo; render();

      // 2) POST por proxy
      try{
        const resp = await fetch(PROXY_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json','X-Auth-Token':PROXY_TOKEN},
          body: JSON.stringify({ submissionId: target.submissionId, qid: QID_ESTADO, value: nuevo })
        });
        const text = await resp.text();
        console.log('Proxy <-', resp.status, text);

        if(!resp.ok){ note(`Error proxy (${resp.status})`, 'error'); return; }

        // 3) Verificar leyendo la submission
        const ok = await verifyRemoteValue(target.submissionId, QID_ESTADO, nuevo);
        if(ok){
          target.estadoJF = nuevo;
          note('Actualizado ✔', 'success');
        }else{
          note('Jotform no refleja el valor (QID/opciones)', 'error');
        }
        render();
      }catch(e){
        console.error(e); note('Error de red/proxy', 'error');
      }
    }

    async function verifyRemoteValue(submissionId, qid, expected){
      try{
        const r = await fetch(`https://api.jotform.com/submission/${submissionId}?apiKey=${apiKey}`);
        const data = await r.json();
        const real = data?.content?.answers?.[qid]?.answer ?? '';
        console.log('Verif JF:', {qid, real, expected});
        return (normalize(real) === normalize(expected));
      }catch(e){ console.log('No verificado',e); return false; }
    }

    function normalize(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }

    // Bootstrap
    (function init(){
      $('apiKey').value = apiKey; $('formId').value = formId;
      $('userBadge').textContent = 'Operador';
    })();

    // Exponer si lo necesitas para debug
    window._dbg = { fetchQuestionsAndGetQID, verifyRemoteValue };
  </script>
</body>
</html>
